@using olieblind.lib.CookieConsent
@using olieblind.lib.Services
@inject ICookieConsentFrontEnd CookieConsent
@inject IOlieConfig Config
@{
    var consentCookie = Context.Request.Cookies[Config.CookieConsentCookieName];
    var status = CookieConsent.GetCookieConsentStatus(consentCookie);
    var blueUrl = CookieConsent.GetBlueApiUrl();
    var pageName = Context.Request.Path.Value ?? string.Empty;
    var showBanner = status == CookieConsentStatusEnum.Unknown || pageName.Split('/')[^1].Equals("CookiePolicy");
    var mustAcceptCookies = status == CookieConsentStatusEnum.All ? "false" : "true";

    if (status == CookieConsentStatusEnum.Unknown)
    {
        Context.Response.Cookies.Delete(Config.CookieConsentCookieName);
    }
}

@if (showBanner)
{
    <!-- Cookie Consent Banner -->
    <div id="CookieConsent" class="alert alert-info fade show border border-primary" role="alert">
        <h4>Cookie Consent</h4>
        <p>
            We use cookies and similar technologies to provide essential site functionality and, 
            with your consent, to analyze site usage and performance. You can choose to accept all cookies 
            or only essential cookies necessary for the site to function properly.
        </p>
        <p>
            <strong>Essential cookies:</strong> Required for basic site functionality, security, and to remember your cookie preferences.<br />
            <strong>Analytics cookies:</strong> Help us understand how visitors interact with our website by collecting and reporting information anonymously.
        </p>
        <p>
            You can change your preferences at any time by accessing the cookie settings through the Cookies link 
            at the bottom of this page. For more information about how we use cookies and process your data, 
            please read our <a asp-page="/About/CookiePolicy" class="alert-link">Cookie Policy</a>.
        </p>
        <div class="d-grid text-center">
            <div class="row">
                <div class="col-sm">
                    <button id="EssentialCookieConsent" type="button" class="btn btn-outline-primary"
                            data-bs-dismiss="alert" aria-label="Accept essential cookies only">
                        Essential Only
                    </button>
                </div>
                <div class="col-sm">
                    <button id="AcceptCookieConsent" type="button" class="btn btn-primary" 
                            data-bs-dismiss="alert" aria-label="Accept all cookies">
                        Accept All
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Declared globally when TrackingConsentFeature is enabled and the user has not consented.
        // Restricts the use of non-essential cookies.
        let mustAcceptCookies = @(mustAcceptCookies);

        (function () {
            function SpewCookieConsent(cookieValue) {
                let xhr = new XMLHttpRequest();
                xhr.open("POST", "@(blueUrl)/api/user/cookieConsent", true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.send(JSON.stringify({ cookieValue }));

                document.cookie = cookieValue;
            }

            const btnAcceptAll = document.querySelector("#AcceptCookieConsent");
            btnAcceptAll.addEventListener("click", function () {
                SpewCookieConsent('@Html.Raw(CookieConsent.CreateBaseCookie(CookieConsentStatusEnum.All))');
                mustAcceptCookies = false;
            }, false);
            const btnEssentialOnly = document.querySelector("#EssentialCookieConsent");
            btnEssentialOnly.addEventListener("click", function () {
                document.cookie = 'ai_session=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;'
                document.cookie = 'ai_user=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;'

                SpewCookieConsent('@Html.Raw(CookieConsent.CreateBaseCookie(CookieConsentStatusEnum.Essential))');
            }, false);
        })();

    </script>
}