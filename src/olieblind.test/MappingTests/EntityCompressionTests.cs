using olieblind.data.Entities;
using olieblind.lib.Mapping;
using System.Text.Json;

namespace olieblind.test.MappingTests;

public class EntityCompressionTests
{
    private readonly List<string> RadarInventory = ["2011/03/22/KABR/KABR20110322_000622_V03.gz", "2011/03/22/KABR/KABR20110322_001552_V03.gz", "2011/03/22/KABR/KABR20110322_002522_V03.gz", "2011/03/22/KABR/KABR20110322_003453_V03.gz", "2011/03/22/KABR/KABR20110322_004424_V03.gz", "2011/03/22/KABR/KABR20110322_005354_V03.gz", "2011/03/22/KABR/KABR20110322_010325_V03.gz", "2011/03/22/KABR/KABR20110322_011255_V03.gz", "2011/03/22/KABR/KABR20110322_012225_V03.gz", "2011/03/22/KABR/KABR20110322_013156_V03.gz", "2011/03/22/KABR/KABR20110322_014126_V03.gz", "2011/03/22/KABR/KABR20110322_014558_V03.gz", "2011/03/22/KABR/KABR20110322_015030_V03.gz", "2011/03/22/KABR/KABR20110322_015502_V03.gz", "2011/03/22/KABR/KABR20110322_015935_V03.gz", "2011/03/22/KABR/KABR20110322_020407_V03.gz", "2011/03/22/KABR/KABR20110322_020840_V03.gz", "2011/03/22/KABR/KABR20110322_021311_V03.gz", "2011/03/22/KABR/KABR20110322_021743_V03.gz", "2011/03/22/KABR/KABR20110322_022214_V03.gz", "2011/03/22/KABR/KABR20110322_022645_V03.gz", "2011/03/22/KABR/KABR20110322_023118_V03.gz", "2011/03/22/KABR/KABR20110322_024046_V03.gz", "2011/03/22/KABR/KABR20110322_025014_V03.gz", "2011/03/22/KABR/KABR20110322_025943_V03.gz", "2011/03/22/KABR/KABR20110322_030554_V03.gz", "2011/03/22/KABR/KABR20110322_031026_V03.gz", "2011/03/22/KABR/KABR20110322_031457_V03.gz", "2011/03/22/KABR/KABR20110322_031928_V03.gz", "2011/03/22/KABR/KABR20110322_032400_V03.gz", "2011/03/22/KABR/KABR20110322_032832_V03.gz", "2011/03/22/KABR/KABR20110322_033303_V03.gz", "2011/03/22/KABR/KABR20110322_033735_V03.gz", "2011/03/22/KABR/KABR20110322_034302_V03.gz", "2011/03/22/KABR/KABR20110322_034733_V03.gz", "2011/03/22/KABR/KABR20110322_035204_V03.gz", "2011/03/22/KABR/KABR20110322_035634_V03.gz", "2011/03/22/KABR/KABR20110322_040106_V03.gz", "2011/03/22/KABR/KABR20110322_040537_V03.gz", "2011/03/22/KABR/KABR20110322_041008_V03.gz", "2011/03/22/KABR/KABR20110322_041439_V03.gz", "2011/03/22/KABR/KABR20110322_041911_V03.gz", "2011/03/22/KABR/KABR20110322_042342_V03.gz", "2011/03/22/KABR/KABR20110322_042812_V03.gz", "2011/03/22/KABR/KABR20110322_043242_V03.gz", "2011/03/22/KABR/KABR20110322_043713_V03.gz", "2011/03/22/KABR/KABR20110322_044143_V03.gz", "2011/03/22/KABR/KABR20110322_044613_V03.gz", "2011/03/22/KABR/KABR20110322_045044_V03.gz", "2011/03/22/KABR/KABR20110322_045514_V03.gz", "2011/03/22/KABR/KABR20110322_045945_V03.gz", "2011/03/22/KABR/KABR20110322_050415_V03.gz", "2011/03/22/KABR/KABR20110322_050845_V03.gz", "2011/03/22/KABR/KABR20110322_051316_V03.gz", "2011/03/22/KABR/KABR20110322_051747_V03.gz", "2011/03/22/KABR/KABR20110322_052218_V03.gz", "2011/03/22/KABR/KABR20110322_052649_V03.gz", "2011/03/22/KABR/KABR20110322_053120_V03.gz", "2011/03/22/KABR/KABR20110322_053550_V03.gz", "2011/03/22/KABR/KABR20110322_054021_V03.gz", "2011/03/22/KABR/KABR20110322_054451_V03.gz", "2011/03/22/KABR/KABR20110322_054922_V03.gz", "2011/03/22/KABR/KABR20110322_055352_V03.gz", "2011/03/22/KABR/KABR20110322_055822_V03.gz", "2011/03/22/KABR/KABR20110322_060253_V03.gz", "2011/03/22/KABR/KABR20110322_060723_V03.gz", "2011/03/22/KABR/KABR20110322_061153_V03.gz", "2011/03/22/KABR/KABR20110322_061623_V03.gz", "2011/03/22/KABR/KABR20110322_062054_V03.gz", "2011/03/22/KABR/KABR20110322_062524_V03.gz", "2011/03/22/KABR/KABR20110322_062955_V03.gz", "2011/03/22/KABR/KABR20110322_063425_V03.gz", "2011/03/22/KABR/KABR20110322_063855_V03.gz", "2011/03/22/KABR/KABR20110322_064325_V03.gz", "2011/03/22/KABR/KABR20110322_064756_V03.gz", "2011/03/22/KABR/KABR20110322_065226_V03.gz", "2011/03/22/KABR/KABR20110322_065657_V03.gz", "2011/03/22/KABR/KABR20110322_070127_V03.gz", "2011/03/22/KABR/KABR20110322_070557_V03.gz", "2011/03/22/KABR/KABR20110322_071027_V03.gz", "2011/03/22/KABR/KABR20110322_071457_V03.gz", "2011/03/22/KABR/KABR20110322_071928_V03.gz", "2011/03/22/KABR/KABR20110322_072358_V03.gz", "2011/03/22/KABR/KABR20110322_072827_V03.gz", "2011/03/22/KABR/KABR20110322_073257_V03.gz", "2011/03/22/KABR/KABR20110322_073727_V03.gz", "2011/03/22/KABR/KABR20110322_074157_V03.gz", "2011/03/22/KABR/KABR20110322_074627_V03.gz", "2011/03/22/KABR/KABR20110322_075057_V03.gz", "2011/03/22/KABR/KABR20110322_075527_V03.gz", "2011/03/22/KABR/KABR20110322_075958_V03.gz", "2011/03/22/KABR/KABR20110322_080428_V03.gz", "2011/03/22/KABR/KABR20110322_080859_V03.gz", "2011/03/22/KABR/KABR20110322_081329_V03.gz", "2011/03/22/KABR/KABR20110322_081759_V03.gz", "2011/03/22/KABR/KABR20110322_082230_V03.gz", "2011/03/22/KABR/KABR20110322_082700_V03.gz", "2011/03/22/KABR/KABR20110322_083130_V03.gz", "2011/03/22/KABR/KABR20110322_083600_V03.gz", "2011/03/22/KABR/KABR20110322_084030_V03.gz", "2011/03/22/KABR/KABR20110322_084459_V03.gz", "2011/03/22/KABR/KABR20110322_084930_V03.gz", "2011/03/22/KABR/KABR20110322_085401_V03.gz", "2011/03/22/KABR/KABR20110322_085832_V03.gz", "2011/03/22/KABR/KABR20110322_090302_V03.gz", "2011/03/22/KABR/KABR20110322_090733_V03.gz", "2011/03/22/KABR/KABR20110322_091203_V03.gz", "2011/03/22/KABR/KABR20110322_091633_V03.gz", "2011/03/22/KABR/KABR20110322_092103_V03.gz", "2011/03/22/KABR/KABR20110322_092533_V03.gz", "2011/03/22/KABR/KABR20110322_093003_V03.gz", "2011/03/22/KABR/KABR20110322_093433_V03.gz", "2011/03/22/KABR/KABR20110322_093903_V03.gz", "2011/03/22/KABR/KABR20110322_094333_V03.gz", "2011/03/22/KABR/KABR20110322_094803_V03.gz", "2011/03/22/KABR/KABR20110322_095233_V03.gz", "2011/03/22/KABR/KABR20110322_095704_V03.gz", "2011/03/22/KABR/KABR20110322_100134_V03.gz", "2011/03/22/KABR/KABR20110322_100605_V03.gz", "2011/03/22/KABR/KABR20110322_101036_V03.gz", "2011/03/22/KABR/KABR20110322_101506_V03.gz", "2011/03/22/KABR/KABR20110322_101936_V03.gz", "2011/03/22/KABR/KABR20110322_102407_V03.gz", "2011/03/22/KABR/KABR20110322_102837_V03.gz", "2011/03/22/KABR/KABR20110322_103306_V03.gz", "2011/03/22/KABR/KABR20110322_103738_V03.gz", "2011/03/22/KABR/KABR20110322_104208_V03.gz", "2011/03/22/KABR/KABR20110322_104637_V03.gz", "2011/03/22/KABR/KABR20110322_105107_V03.gz", "2011/03/22/KABR/KABR20110322_105538_V03.gz", "2011/03/22/KABR/KABR20110322_110007_V03.gz", "2011/03/22/KABR/KABR20110322_110437_V03.gz", "2011/03/22/KABR/KABR20110322_110907_V03.gz", "2011/03/22/KABR/KABR20110322_111337_V03.gz", "2011/03/22/KABR/KABR20110322_111807_V03.gz", "2011/03/22/KABR/KABR20110322_112237_V03.gz", "2011/03/22/KABR/KABR20110322_112707_V03.gz", "2011/03/22/KABR/KABR20110322_113138_V03.gz", "2011/03/22/KABR/KABR20110322_113608_V03.gz", "2011/03/22/KABR/KABR20110322_114039_V03.gz", "2011/03/22/KABR/KABR20110322_114605_V03.gz", "2011/03/22/KABR/KABR20110322_115035_V03.gz", "2011/03/22/KABR/KABR20110322_115504_V03.gz", "2011/03/22/KABR/KABR20110322_115935_V03.gz", "2011/03/22/KABR/KABR20110322_120405_V03.gz", "2011/03/22/KABR/KABR20110322_120835_V03.gz", "2011/03/22/KABR/KABR20110322_121306_V03.gz", "2011/03/22/KABR/KABR20110322_121736_V03.gz", "2011/03/22/KABR/KABR20110322_122206_V03.gz", "2011/03/22/KABR/KABR20110322_122636_V03.gz", "2011/03/22/KABR/KABR20110322_123106_V03.gz", "2011/03/22/KABR/KABR20110322_123536_V03.gz", "2011/03/22/KABR/KABR20110322_124007_V03.gz", "2011/03/22/KABR/KABR20110322_124437_V03.gz", "2011/03/22/KABR/KABR20110322_124907_V03.gz", "2011/03/22/KABR/KABR20110322_125337_V03.gz", "2011/03/22/KABR/KABR20110322_125807_V03.gz", "2011/03/22/KABR/KABR20110322_130238_V03.gz", "2011/03/22/KABR/KABR20110322_130708_V03.gz", "2011/03/22/KABR/KABR20110322_131138_V03.gz", "2011/03/22/KABR/KABR20110322_131608_V03.gz", "2011/03/22/KABR/KABR20110322_132038_V03.gz", "2011/03/22/KABR/KABR20110322_132508_V03.gz", "2011/03/22/KABR/KABR20110322_132937_V03.gz", "2011/03/22/KABR/KABR20110322_133407_V03.gz", "2011/03/22/KABR/KABR20110322_133838_V03.gz", "2011/03/22/KABR/KABR20110322_134308_V03.gz", "2011/03/22/KABR/KABR20110322_134738_V03.gz", "2011/03/22/KABR/KABR20110322_135209_V03.gz", "2011/03/22/KABR/KABR20110322_135639_V03.gz", "2011/03/22/KABR/KABR20110322_140109_V03.gz", "2011/03/22/KABR/KABR20110322_140540_V03.gz", "2011/03/22/KABR/KABR20110322_141010_V03.gz", "2011/03/22/KABR/KABR20110322_141440_V03.gz", "2011/03/22/KABR/KABR20110322_141911_V03.gz", "2011/03/22/KABR/KABR20110322_142341_V03.gz", "2011/03/22/KABR/KABR20110322_142811_V03.gz", "2011/03/22/KABR/KABR20110322_143242_V03.gz", "2011/03/22/KABR/KABR20110322_143712_V03.gz", "2011/03/22/KABR/KABR20110322_144143_V03.gz", "2011/03/22/KABR/KABR20110322_144614_V03.gz", "2011/03/22/KABR/KABR20110322_145043_V03.gz", "2011/03/22/KABR/KABR20110322_145513_V03.gz", "2011/03/22/KABR/KABR20110322_145943_V03.gz", "2011/03/22/KABR/KABR20110322_150414_V03.gz", "2011/03/22/KABR/KABR20110322_150844_V03.gz", "2011/03/22/KABR/KABR20110322_151315_V03.gz", "2011/03/22/KABR/KABR20110322_152241_V03.gz", "2011/03/22/KABR/KABR20110322_153207_V03.gz", "2011/03/22/KABR/KABR20110322_154134_V03.gz", "2011/03/22/KABR/KABR20110322_155102_V03.gz", "2011/03/22/KABR/KABR20110322_160029_V03.gz", "2011/03/22/KABR/KABR20110322_160957_V03.gz", "2011/03/22/KABR/KABR20110322_161924_V03.gz", "2011/03/22/KABR/KABR20110322_162853_V03.gz", "2011/03/22/KABR/KABR20110322_163821_V03.gz", "2011/03/22/KABR/KABR20110322_164749_V03.gz", "2011/03/22/KABR/KABR20110322_165718_V03.gz", "2011/03/22/KABR/KABR20110322_170647_V03.gz", "2011/03/22/KABR/KABR20110322_171615_V03.gz", "2011/03/22/KABR/KABR20110322_172544_V03.gz", "2011/03/22/KABR/KABR20110322_173513_V03.gz", "2011/03/22/KABR/KABR20110322_174442_V03.gz", "2011/03/22/KABR/KABR20110322_175412_V03.gz", "2011/03/22/KABR/KABR20110322_175843_V03.gz", "2011/03/22/KABR/KABR20110322_180315_V03.gz", "2011/03/22/KABR/KABR20110322_180746_V03.gz", "2011/03/22/KABR/KABR20110322_181218_V03.gz", "2011/03/22/KABR/KABR20110322_181649_V03.gz", "2011/03/22/KABR/KABR20110322_182121_V03.gz", "2011/03/22/KABR/KABR20110322_182552_V03.gz", "2011/03/22/KABR/KABR20110322_183023_V03.gz", "2011/03/22/KABR/KABR20110322_183456_V03.gz", "2011/03/22/KABR/KABR20110322_183927_V03.gz", "2011/03/22/KABR/KABR20110322_184358_V03.gz", "2011/03/22/KABR/KABR20110322_184829_V03.gz", "2011/03/22/KABR/KABR20110322_185259_V03.gz", "2011/03/22/KABR/KABR20110322_185730_V03.gz", "2011/03/22/KABR/KABR20110322_190200_V03.gz", "2011/03/22/KABR/KABR20110322_190631_V03.gz", "2011/03/22/KABR/KABR20110322_191102_V03.gz", "2011/03/22/KABR/KABR20110322_191532_V03.gz", "2011/03/22/KABR/KABR20110322_192003_V03.gz", "2011/03/22/KABR/KABR20110322_192433_V03.gz", "2011/03/22/KABR/KABR20110322_192904_V03.gz", "2011/03/22/KABR/KABR20110322_193334_V03.gz", "2011/03/22/KABR/KABR20110322_193804_V03.gz", "2011/03/22/KABR/KABR20110322_194235_V03.gz", "2011/03/22/KABR/KABR20110322_194801_V03.gz", "2011/03/22/KABR/KABR20110322_195231_V03.gz", "2011/03/22/KABR/KABR20110322_195702_V03.gz", "2011/03/22/KABR/KABR20110322_200132_V03.gz", "2011/03/22/KABR/KABR20110322_200603_V03.gz", "2011/03/22/KABR/KABR20110322_201033_V03.gz", "2011/03/22/KABR/KABR20110322_201504_V03.gz", "2011/03/22/KABR/KABR20110322_201934_V03.gz", "2011/03/22/KABR/KABR20110322_202404_V03.gz", "2011/03/22/KABR/KABR20110322_202835_V03.gz", "2011/03/22/KABR/KABR20110322_203305_V03.gz", "2011/03/22/KABR/KABR20110322_203735_V03.gz", "2011/03/22/KABR/KABR20110322_204205_V03.gz", "2011/03/22/KABR/KABR20110322_204636_V03.gz", "2011/03/22/KABR/KABR20110322_205107_V03.gz", "2011/03/22/KABR/KABR20110322_205537_V03.gz", "2011/03/22/KABR/KABR20110322_210009_V03.gz", "2011/03/22/KABR/KABR20110322_210439_V03.gz", "2011/03/22/KABR/KABR20110322_210909_V03.gz", "2011/03/22/KABR/KABR20110322_211339_V03.gz", "2011/03/22/KABR/KABR20110322_211809_V03.gz", "2011/03/22/KABR/KABR20110322_212239_V03.gz", "2011/03/22/KABR/KABR20110322_212710_V03.gz", "2011/03/22/KABR/KABR20110322_213140_V03.gz", "2011/03/22/KABR/KABR20110322_213610_V03.gz", "2011/03/22/KABR/KABR20110322_214040_V03.gz", "2011/03/22/KABR/KABR20110322_214510_V03.gz", "2011/03/22/KABR/KABR20110322_214940_V03.gz", "2011/03/22/KABR/KABR20110322_215411_V03.gz", "2011/03/22/KABR/KABR20110322_215841_V03.gz", "2011/03/22/KABR/KABR20110322_220311_V03.gz", "2011/03/22/KABR/KABR20110322_220742_V03.gz", "2011/03/22/KABR/KABR20110322_221212_V03.gz", "2011/03/22/KABR/KABR20110322_221642_V03.gz", "2011/03/22/KABR/KABR20110322_222113_V03.gz", "2011/03/22/KABR/KABR20110322_222544_V03.gz", "2011/03/22/KABR/KABR20110322_223014_V03.gz", "2011/03/22/KABR/KABR20110322_223445_V03.gz", "2011/03/22/KABR/KABR20110322_223915_V03.gz", "2011/03/22/KABR/KABR20110322_224344_V03.gz", "2011/03/22/KABR/KABR20110322_224814_V03.gz", "2011/03/22/KABR/KABR20110322_225244_V03.gz", "2011/03/22/KABR/KABR20110322_225714_V03.gz", "2011/03/22/KABR/KABR20110322_230144_V03.gz", "2011/03/22/KABR/KABR20110322_230613_V03.gz", "2011/03/22/KABR/KABR20110322_231044_V03.gz", "2011/03/22/KABR/KABR20110322_231513_V03.gz", "2011/03/22/KABR/KABR20110322_231943_V03.gz", "2011/03/22/KABR/KABR20110322_232413_V03.gz", "2011/03/22/KABR/KABR20110322_232843_V03.gz", "2011/03/22/KABR/KABR20110322_233313_V03.gz", "2011/03/22/KABR/KABR20110322_233743_V03.gz", "2011/03/22/KABR/KABR20110322_234213_V03.gz", "2011/03/22/KABR/KABR20110322_234642_V03.gz", "2011/03/22/KABR/KABR20110322_235113_V03.gz", "2011/03/22/KABR/KABR20110322_235543_V03.gz"];

    private static List<string> DeepCopy(List<string> source)
    {
        var json = JsonSerializer.Serialize(source);
        var result = JsonSerializer.Deserialize<List<string>>(json) ?? throw new InvalidDataException();

        return result;
    }

    private static int CombinedLength(List<string> source)
    {
        return JsonSerializer.Serialize(source).Length;
    }

    #region RadarInventoryEntity

    [Test]
    public void CompressRadarInventoryEntity_Compresses_ManyItems()
    {
        var list = DeepCopy(RadarInventory);
        var uncompressed = CombinedLength(list);
        var entity = new RadarInventoryEntity { FileList = list };

        EntityCompression.Compress(entity);

        var compressed = CombinedLength(list);

        using (Assert.EnterMultipleScope())
        {
            Assert.That(uncompressed, Is.EqualTo(12781));
            Assert.That(compressed, Is.EqualTo(3159));
        }
    }

    [Test]
    public void CompressRadarInventoryEntity_DoesNothing_FewItems()
    {
        var list = new List<string> { "2011/03/22/KABR/KABR20110322_000622_V03.gz" };
        var uncompressed = CombinedLength(list);
        var entity = new RadarInventoryEntity { FileList = list };

        EntityCompression.Compress(entity);

        var compressed = CombinedLength(list);

        Assert.That(uncompressed, Is.EqualTo(compressed));
    }

    [Test]
    public void DecompressRadarInventoryEntity_NoLossOfData_ManyItems()
    {
        var list = DeepCopy(RadarInventory);
        var uncompressed = JsonSerializer.Serialize(list);
        var entity = new RadarInventoryEntity { FileList = list };

        EntityCompression.Compress(entity);

        var compressed = JsonSerializer.Serialize(list);

        EntityCompression.Decompress(entity);

        var decompressed = JsonSerializer.Serialize(list);

        using (Assert.EnterMultipleScope())
        {
            Assert.That(uncompressed, Is.EqualTo(decompressed));
            Assert.That(uncompressed, Is.Not.EqualTo(compressed));
        }
    }

    [Test]
    public void DecompressRadarInventoryEntity_DoesNothing_FewItems()
    {
        var list = new List<string> { "2011/03/22/KABR/KABR20110322_000622_V03.gz" };
        var uncompressed = JsonSerializer.Serialize(list);
        var entity = new RadarInventoryEntity { FileList = list };

        EntityCompression.Compress(entity);

        var compressed = JsonSerializer.Serialize(list);

        EntityCompression.Decompress(entity);

        var decompressed = JsonSerializer.Serialize(list);

        using (Assert.EnterMultipleScope())
        {
            Assert.That(uncompressed, Is.EqualTo(decompressed));
            Assert.That(uncompressed, Is.EqualTo(compressed));
        }
    }

    [Test]
    public void DecompressRadarInventoryEntity_DoesNothing_UnexpectedData()
    {
        var list = new List<string> { "2011/03/22/KABR/KABR20110322_000622V03.gz", "2011/03/22/KABR/KABR20110322_001552_V03.gz" };
        var uncompressed = JsonSerializer.Serialize(list);
        var entity = new RadarInventoryEntity { FileList = list };

        EntityCompression.Compress(entity);

        var compressed = JsonSerializer.Serialize(list);

        EntityCompression.Decompress(entity);

        var decompressed = JsonSerializer.Serialize(list);

        using (Assert.EnterMultipleScope())
        {
            Assert.That(uncompressed, Is.EqualTo(decompressed));
            Assert.That(uncompressed, Is.EqualTo(compressed));
        }
    }

    #endregion
}
